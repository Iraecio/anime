<div class="container-fluid bg-dark text-white min-vh-100 py-4">
  <!-- Barra de Busca -->
  <div class="row justify-content-center mb-5">
    <div class="col-lg-8 col-xl-6">
      <div class="card bg-secondary border-0 shadow">
        <div class="card-body">
          <div class="input-group input-group-lg">
            <input type="text" class="form-control border-0 bg-dark text-white"
              placeholder="Buscar animes por t√≠tulo..." [(ngModel)]="searchQuery" (input)="onSearchInput()"
              [disabled]="showLoading()">
            <div class="input-group-text bg-dark border-0">
              @if (isSearching()) {
              <div class="spinner-border spinner-border-sm text-primary" role="status">
                <span class="visually-hidden">Carregando...</span>
              </div>
              } @else if (searchQuery()) {
              <button class="btn btn-sm btn-outline-danger border-0 p-1" (click)="clearSearch()" title="Limpar busca">
                ‚úï
              </button>
              } @else {
              <span class="text-muted">üîç</span>
              }
            </div>
          </div>

          @if (isInSearchMode()) {
          <div class="mt-3 text-center">
            <small class="text-muted ">
              {{ totalAnimes() }} resultado{{ totalAnimes() !== 1 ? 's' : '' }}
              para "<span class="text-info">{{ searchQuery() }}</span>"
            </small>
          </div>
          }
        </div>
      </div>
    </div>
  </div>

  <!-- Header do mostru√°rio -->
  <div class="text-center mb-5">
    <h1 class="display-4 fw-bold mb-3">
      {{ isInSearchMode() ? 'Resultados da Busca' : 'Mostru√°rio de Animes' }}
    </h1>
    <p class="lead text-white mb-4">
      Mostrando {{ pageInfo().start }} - {{ pageInfo().end }} de {{ pageInfo().total }} {{ isInSearchMode() ? 'resultados'
      : 'animes' }}
    </p>

    @if (showLoading()) {
    <div class="d-flex justify-content-center align-items-center">
      <div class="spinner-border text-primary me-2" role="status">
        <span class="visually-hidden">Carregando...</span>
      </div>
      <span class="text-primary">{{ isInSearchMode() ? 'Buscando' : 'Carregando' }} animes...</span>
    </div>
    }
  </div>

  <!-- Grid de animes -->
  <div class="row">
    @if (showLoading()) {
    <div class="col-12">
      <div class="d-flex flex-column align-items-center justify-content-center py-5">
        <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
          <span class="visually-hidden">Carregando...</span>
        </div>
        <p class="h5 text-muted">{{ isInSearchMode() ? 'Buscando' : 'Carregando' }} animes...</p>
      </div>
    </div>
    } @else if (animes().length === 0 && isInSearchMode()) {
    <div class="col-12">
      <div class="text-center py-5">
        <div class="display-1 mb-4">üîç</div>
        <h3 class="h2 mb-3">Nenhum anime encontrado</h3>
        <p class="lead text-muted mb-4">N√£o encontramos animes com o termo "<span class="text-info">{{ searchQuery()
            }}</span>"</p>
        <button class="btn btn-primary btn-lg" (click)="clearSearch()">
          ‚Üê Ver todos os animes
        </button>
      </div>
    </div>
    } @else {
    @for (anime of paginatedResult().data; track anime.id; let i = $index) {
    <div class="col-6 col-sm-4 col-md-3 col-lg-2 col-xl-2 mb-4">
      <div class="card bg-secondary border-0 shadow anime-card h-100 position-relative"
        [class.expanded]="isAnimeExpanded(anime.id)" (click)="toggleAnimeExpansion(anime, i)"
        style="cursor: pointer; transition: transform 0.2s ease;" tabindex="0" role="button"
        [attr.aria-expanded]="isAnimeExpanded(anime.id)" [attr.aria-label]="'Ver epis√≥dios de ' + anime.titulo"
        (keydown.enter)="toggleAnimeExpansion(anime, i)"
        (keydown.space)="toggleAnimeExpansion(anime, i); $event.preventDefault()">

        <!-- Imagem do anime -->
        <div class="position-relative overflow-hidden" style="height: 300px;">
          <img [src]="anime.thumb" [alt]="anime.titulo" class="card-img-top h-100 w-100 object-fit-cover" loading="lazy"
            onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjNjY2Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iI2ZmZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkltYWdlbSBOw6NvIEVuY29udHJhZGE8L3RleHQ+PC9zdmc+'" />

          <!-- Overlay com rating -->
          <div
            class="position-absolute top-0 start-0 w-100 h-100 d-flex flex-column justify-content-between p-2 anime-overlay"
            style="background: linear-gradient(180deg, rgba(0,0,0,0.4) 0%, transparent 50%, rgba(0,0,0,0.8) 100%); opacity: 0; transition: opacity 0.3s ease;">
            <div class="align-self-start">
              <span class="badge bg-warning text-dark">
                ‚òÖ 9.0
              </span>
            </div>
          </div>
        </div>

        <!-- T√≠tulo do anime -->
        <div class="card-body p-3 text-center">
          <h6 class="card-title text-white mb-0 fw-semibold lh-sm anime-title-clamp" [title]="anime.titulo">
            {{ anime.titulo }}
          </h6>
        </div>

        <!-- Painel de epis√≥dios (quando expandido) -->
        @if (isAnimeExpanded(anime.id)) {
        <div
          class="position-absolute top-0 start-0 w-100 h-100 bg-dark border border-primary rounded episodes-panel shadow-lg"
          [class.expand-left]="expandDirection() === 'left'" [class.expand-right]="expandDirection() === 'right'"
          style="z-index: 1000; animation: expandPanel 0.3s ease-out;" role="dialog"
          [attr.aria-label]="'Epis√≥dios de ' + expandedAnime()?.titulo">

          <!-- Header do painel -->
          <div class="d-flex justify-content-between align-items-center p-3 bg-primary text-white">
            <h6 class="mb-0 fw-bold text-truncate me-2">{{ expandedAnime()?.titulo }}</h6>
            <button class="btn btn-sm btn-outline-light border-0 p-1 rounded-circle"
              (click)="closeExpansion(); $event.stopPropagation()" (keydown.escape)="closeExpansion()"
              title="Fechar painel de epis√≥dios" aria-label="Fechar painel de epis√≥dios"
              style="width: 32px; height: 32px;">
              <i class="bi bi-x-lg"></i>
            </button>
          </div>

          <!-- Lista de epis√≥dios -->
          <div class="p-2 overflow-auto" style="height: calc(100% - 56px); max-height: 100%;">
            @if (expandedEpisodes().length === 0) {
            <div class="text-center text-muted py-4">
              <div class="mb-2">üì∫</div>
              <small>Nenhum epis√≥dio dispon√≠vel</small>
            </div>
            } @else {
            @for (episode of expandedEpisodes(); track episode.id) {
            <div class="d-flex align-items-center p-2 mb-1 rounded episode-item border"
              [class.bg-success]="isEpisodeWatched(episode)" [class.border-success]="isEpisodeWatched(episode)"
              [class.bg-secondary]="!isEpisodeWatched(episode)" [class.border-secondary]="!isEpisodeWatched(episode)"
              style="cursor: pointer; transition: all 0.2s ease; min-height: 50px;" tabindex="0" role="button"
              (click)="playEpisode(episode)" (keydown.enter)="playEpisode(episode)"
              (keydown.space)="playEpisode(episode); $event.preventDefault()"
              [attr.aria-label]="'Assistir epis√≥dio ' + episode.numero + (isEpisodeWatched(episode) ? ' (j√° assistido)' : '')">

              <!-- N√∫mero do epis√≥dio -->
              <div class="badge me-2 flex-shrink-0" [class.bg-success]="isEpisodeWatched(episode)"
                [class.bg-primary]="!isEpisodeWatched(episode)"
                style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem;">
                {{ episode.numero }}
              </div>

              <!-- Info do epis√≥dio -->
              <div class="flex-grow-1 min-width-0">
                <div class="fw-semibold text-white text-truncate d-flex align-items-center" style="font-size: 0.85rem;">
                  <span>Ep. {{ episode.numero }}</span>
                  @if (isEpisodeWatched(episode)) {
                  <i class="bi bi-check-circle-fill text-success ms-1" style="font-size: 0.75rem;"
                    title="Assistido"></i>
                  }
                </div>
                <div class="small text-muted" style="font-size: 0.7rem;">
                  <i class="bi bi-clock me-1"></i>24min
                  @if (!isEpisodeWatched(episode)) {
                  <i class="bi bi-play-circle ms-1" title="Clique para assistir"></i>
                  }
                </div>
              </div>

              <!-- Indicador visual de a√ß√£o -->
              <div class="flex-shrink-0">
                <i class="bi bi-chevron-right text-muted" style="font-size: 0.8rem;"></i>
              </div>
            </div>
            }
            }
          </div>
        </div>
        }
      </div>
    </div>
    }
    }
  </div>

  <!-- Pagina√ß√£o -->
  <div class="d-flex flex-column align-items-center gap-3 mt-5">
    <!-- Controles de pagina√ß√£o -->
    <nav aria-label="Navega√ß√£o da p√°gina">
      <ul class="pagination pagination-lg mb-0">
        <!-- Primeira p√°gina -->
        <li class="page-item" [class.disabled]="!canGoPrevious()">
          <button class="page-link bg-secondary border-secondary text-white" [disabled]="!canGoPrevious()"
            (click)="goToFirstPage()" title="Primeira p√°gina">
            ¬´¬´
          </button>
        </li>

        <!-- P√°gina anterior -->
        <li class="page-item" [class.disabled]="!canGoPrevious()">
          <button class="page-link bg-secondary border-secondary text-white" [disabled]="!canGoPrevious()"
            (click)="previousPage()" title="P√°gina anterior">
            ‚Äπ
          </button>
        </li>

        <!-- N√∫meros das p√°ginas -->
        @for (pageNum of pageNumbers(); track pageNum) {
        <li class="page-item" [class.active]="pageNum === currentPage()">
          <button class="page-link" [class.bg-primary]="pageNum === currentPage()"
            [class.border-primary]="pageNum === currentPage()" [class.bg-secondary]="pageNum !== currentPage()"
            [class.border-secondary]="pageNum !== currentPage()" [class.text-white]="true" (click)="goToPage(pageNum)">
            {{ pageNum }}
          </button>
        </li>
        }

        <!-- Pr√≥xima p√°gina -->
        <li class="page-item" [class.disabled]="!canGoNext()">
          <button class="page-link bg-secondary border-secondary text-white" [disabled]="!canGoNext()"
            (click)="nextPage()" title="Pr√≥xima p√°gina">
            ‚Ä∫
          </button>
        </li>

        <!-- √öltima p√°gina -->
        <li class="page-item" [class.disabled]="!canGoNext()">
          <button class="page-link bg-secondary border-secondary text-white" [disabled]="!canGoNext()"
            (click)="goToLastPage()" title="√öltima p√°gina">
            ¬ª¬ª
          </button>
        </li>
      </ul>
    </nav>

    <!-- Informa√ß√µes da p√°gina -->
    <div class="text-muted">
      <small>P√°gina {{ currentPage() }} de {{ totalPages() }}</small>
    </div>
  </div>
</div>