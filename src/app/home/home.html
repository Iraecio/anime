<!-- Header Navigation -->
<header class="header-navbar bg-dark border-bottom border-secondary position-sticky top-0" style="z-index: 1000;">
  <div class="container-fluid">
    <div class="row align-items-center py-3">
      <!-- Logo/Brand -->
      <div class="col-auto">
        <h1 class="h3 mb-0 text-white fw-bold">
          <span class="text-danger">Animes</span> BR
        </h1>
      </div>

      <!-- Search Bar (centered) -->
      <div class="col">
        <div class="d-flex justify-content-center">
          <div class="search-container" style="width: 80%;">
            <div class="input-group">
              <input type="text" class="form-control bg-dark text-white border-secondary"
                placeholder="Buscar animes por t√≠tulo..." [(ngModel)]="searchQuery" (input)="onSearchInput()"
                (keyup.enter)="onSearchEnter()" #searchInput>
              <div class="input-group-text bg-dark border-secondary">
                @if (isSearching()) {
                <div class="spinner-border spinner-border-sm text-primary" role="status">
                  <span class="visually-hidden">Carregando...</span>
                </div>
                } @else if (searchQuery()) {
                <button class="btn btn-sm text-danger border-0 p-1 d-flex align-items-center justify-content-center" 
                        (click)="clearSearch()" title="Limpar busca">
                  <!-- YouTube Clear/Close Icon -->
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" 
                          fill="currentColor"/>
                  </svg>
                </button>
                } @else {
                <!-- YouTube Search Icon -->
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="text-muted">
                  <path d="M20.87 20.17l-5.59-5.59C16.35 13.35 17 11.75 17 10c0-3.87-3.13-7-7-7s-7 3.13-7 7 3.13 7 7 7c1.75 0 3.35-.65 4.58-1.71l5.59 5.59.7-.71zM10 16c-3.31 0-6-2.69-6-6s2.69-6 6-6 6 2.69 6 6-2.69 6-6 6z" 
                        fill="currentColor"/>
                </svg>
                }
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Cache Debug Component (only in development) -->
    @if (showCacheDebug()) {
    <div class="row">
      <div class="col-12">
        <app-cache-debug></app-cache-debug>
      </div>
    </div>
    }
  </div>
</header>

<div class="container-fluid bg-dark text-white min-vh-100 py-4" style="padding-top: 2rem !important;">

  <!-- Header do mostru√°rio -->
  <div class="text-center mb-5">
    <p class="lead text-white mb-4">
      Mostrando {{ pageInfo().start }} - {{ pageInfo().end }} de {{ pageInfo().total }} {{ isInSearchMode() ?
      'resultados'
      : 'animes' }}
    </p>

    @if (showDataLoading()) {
    <div class="d-flex justify-content-center align-items-center">
      <div class="spinner-border text-primary me-2" role="status">
        <span class="visually-hidden">Carregando...</span>
      </div>
      <span class="text-primary">{{ isInSearchMode() ? 'Buscando' : 'Carregando' }} animes...</span>
    </div>
    }
  </div>

  <!-- Grid de animes -->
  <div class="row">
    @if (showDataLoading()) {
    <div class="col-12">
      <div class="d-flex flex-column align-items-center justify-content-center py-5">
        <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
          <span class="visually-hidden">Carregando...</span>
        </div>
        <p class="h5 text-muted">{{ isInSearchMode() ? 'Buscando' : 'Carregando' }} animes...</p>
      </div>
    </div>
    } @else if (animes().length === 0 && isInSearchMode()) {
    <div class="col-12">
      <div class="text-center py-5">
        <div class="display-1 mb-4">üîç</div>
        <h3 class="h2 mb-3">Nenhum anime encontrado</h3>
        <p class="lead text-muted mb-4">N√£o encontramos animes com o termo "<span class="text-info">{{ searchQuery()
            }}</span>"</p>
        <button class="btn btn-primary btn-lg" (click)="clearSearch()">
          ‚Üê Ver todos os animes
        </button>
      </div>
    </div>
    } @else {
    @for (anime of paginatedResult().data; track anime.id; let i = $index) {
    <div class="col-6 col-sm-4 col-md-3 col-lg-2 col-xl-2 mb-4">
      <div class="netflix-card-container" 
        (click)="handleAnimeCardClick(anime, i)"
        (keydown.enter)="handleAnimeCardClick(anime, i)"
        (keydown.space)="handleAnimeCardClick(anime, i); $event.preventDefault()" tabindex="0" role="button"
        [attr.aria-expanded]="isAnimeExpanded(anime.id)" [attr.aria-label]="'Ver epis√≥dios de ' + anime.titulo"
        [class.adult-content-card]="isAdultContent(anime)"
        [class.adult-content-revealed]="isAdultContent(anime) && isAdultContentRevealed(anime.id)">

        <div class="netflix-card" [class.flipped]="isAnimeExpanded(anime.id)">
          <!-- Frente do card -->
          <div class="netflix-card-front">
            <div class="netflix-card-image">
              <img [src]="anime.thumb" [alt]="anime.titulo" loading="lazy"
                onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjQwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjMjIxIi8+PHRleHQgeD0iNTAlIiB5PSI0NSUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iI2ZmZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkFuaW1lPC90ZXh0PjxjaXJjbGUgY3g9IjUwJSIgY3k9IjU1JSIgcj0iMTAiIGZpbGw9IiNlNTA5MTQiLz48L3N2Zz4='" />

              <!-- Camada de blur para conte√∫do +18 -->
              @if (isAdultContent(anime) && !isAdultContentRevealed(anime.id)) {
              <div class="adult-content-overlay" (click)="toggleAdultContentReveal(anime.id, $event)">
                <div class="adult-content-blur"></div>
                <div class="adult-content-icon">
                  <!-- √çcone de olho fechado -->
                  <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z" fill="currentColor"/>
                  </svg>
                  <span class="adult-content-text">Conte√∫do +18</span>
                  <small class="adult-content-hint">Clique para revelar</small>
                </div>
              </div>
              }

              <!-- Overlay gradient -->
              <div class="netflix-card-gradient"></div>

              <!-- Play button overlay -->
              <div class="netflix-play-button">
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M8 5v14l11-7z" />
                </svg>
              </div>

              <!-- Rating badge -->
              <div class="netflix-rating">
                <span class="netflix-match">{{ getMatchPercentage(anime) }}% Match</span>
              </div>
            </div>

            <!-- Card info -->
            <div class="netflix-card-info">
              <h3 class="netflix-title">{{ anime.titulo }}</h3>
              <div class="netflix-meta">
                <span class="netflix-episodes-count">{{ anime.episodios.length }} ep.</span>
                @if (anime.dublado) {
                <span class="netflix-dubbed">DUB</span>
                } @else {
                <span class="netflix-dubbed">LEG</span>
                }

                @if (anime.ano) {
                <span class="netflix-year">{{ anime.ano }}</span>
                }
              </div>
              <div class="netflix-genres">
                @for (item of anime.generos.slice(0, 3); track $index) {
                <span class="netflix-genre">{{ item }}</span>
                }
                @if (anime.generos.length > 3) {
                <span class="netflix-genre netflix-genre-more">+{{ anime.generos.length - 3 }}</span>
                }
              </div>
            </div>
          </div>

          <!-- Verso do card (lista de epis√≥dios) -->
          <div class="netflix-card-back">
            <div class="netflix-episodes-header">
              <button class="netflix-close-btn" (click)="closeExpansion(); $event.stopPropagation()"
                (keydown.escape)="closeExpansion()" aria-label="Fechar painel de epis√≥dios">
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <path
                    d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
                </svg>
              </button>
              <h4 class="netflix-episodes-title">{{ expandedAnime()?.titulo }}</h4>
              <span class="netflix-total-episodes">{{ expandedEpisodes().length }} epis√≥dios</span>
            </div>

            <div class="netflix-episodes-list">
              @if (expandedEpisodes().length === 0) {
              <div class="netflix-no-episodes">
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <path
                    d="M21,3H3C2,3 1,4 1,5V19A1,1 0 0,0 2,20H22A1,1 0 0,0 23,19V5C23,4 22,3 21,3M21,18H3V6H21V18Z" />
                </svg>
                <p>Nenhum epis√≥dio dispon√≠vel</p>
              </div>
              } @else {
              @for (episode of expandedEpisodes(); track episode.id) {
              <div class="netflix-episode-item" [class.watched]="isEpisodeWatched(episode)"
                (click)="playEpisode(episode)" (keydown.enter)="playEpisode(episode)"
                (keydown.space)="playEpisode(episode); $event.preventDefault()" tabindex="0" role="button"
                [attr.aria-label]="'Assistir epis√≥dio ' + episode.numero + (isEpisodeWatched(episode) ? ' (j√° assistido)' : '')">

                <div class="netflix-episode-number">
                  <span>{{ episode.numero }}</span>
                  @if (isEpisodeWatched(episode)) {
                  <div class="netflix-watched-indicator">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" />
                    </svg>
                  </div>
                  }
                </div>

                <div class="netflix-episode-info">
                  <h5 class="netflix-episode-title">Epis√≥dio {{ episode.numero }}</h5>
                  <p class="netflix-episode-duration">24min</p>
                </div>

                <div class="netflix-episode-play">
                  <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M8 5v14l11-7z" />
                  </svg>
                </div>
              </div>
              }
              }
            </div>
          </div>
        </div>
      </div>
    </div>
    }
    }
  </div>

  <!-- Pagina√ß√£o -->
  <div class="d-flex flex-column align-items-center gap-3 mt-5">
    <!-- Controles de pagina√ß√£o -->
    <nav aria-label="Navega√ß√£o da p√°gina">
      <ul class="pagination pagination-lg mb-0">
        <!-- Primeira p√°gina -->
        <li class="page-item" [class.disabled]="!canGoPrevious()">
          <button class="page-link bg-secondary border-secondary text-white" [disabled]="!canGoPrevious()"
            (click)="goToFirstPage()" title="Primeira p√°gina">
            ¬´¬´
          </button>
        </li>

        <!-- P√°gina anterior -->
        <li class="page-item" [class.disabled]="!canGoPrevious()">
          <button class="page-link bg-secondary border-secondary text-white" [disabled]="!canGoPrevious()"
            (click)="previousPage()" title="P√°gina anterior">
            ‚Äπ
          </button>
        </li>

        <!-- N√∫meros das p√°ginas -->
        @for (pageNum of pageNumbers(); track pageNum) {
        <li class="page-item" [class.active]="pageNum === currentPage()">
          <button class="page-link" [class.bg-primary]="pageNum === currentPage()"
            [class.border-primary]="pageNum === currentPage()" [class.bg-secondary]="pageNum !== currentPage()"
            [class.border-secondary]="pageNum !== currentPage()" [class.text-white]="true" (click)="goToPage(pageNum)">
            {{ pageNum }}
          </button>
        </li>
        }

        <!-- Pr√≥xima p√°gina -->
        <li class="page-item" [class.disabled]="!canGoNext()">
          <button class="page-link bg-secondary border-secondary text-white" [disabled]="!canGoNext()"
            (click)="nextPage()" title="Pr√≥xima p√°gina">
            ‚Ä∫
          </button>
        </li>

        <!-- √öltima p√°gina -->
        <li class="page-item" [class.disabled]="!canGoNext()">
          <button class="page-link bg-secondary border-secondary text-white" [disabled]="!canGoNext()"
            (click)="goToLastPage()" title="√öltima p√°gina">
            ¬ª¬ª
          </button>
        </li>
      </ul>
    </nav>

    <!-- Informa√ß√µes da p√°gina -->
    <div class="text-muted">
      <small>P√°gina {{ currentPage() }} de {{ totalPages() }}</small>
    </div>
  </div>
</div>